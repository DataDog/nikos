---
- name: create a directory if it does not exist
  file:
    path: "{{ output_path }}"
    state: directory
    mode: 0777

- name: run nikos
  shell: "{{ prefix | default('') }} bash -c 'SSL_CERT_DIR=/opt/nikos/embedded/ssl/ PATH=$PATH:/opt/nikos/embedded/bin /opt/nikos/bin/nikos download --output {{ output_path }} 2>&1 tee {{ output_path }}/logs.txt'"
  register: nikos_result

- debug:
    var: nikos_result.stdout_lines

- name: nikos ran successfully
  assert:
    that: nikos_result.rc == 0

- include_tasks: verify-package-deb.yml
  when: ansible_lsb.id is defined and (ansible_lsb.id == "Ubuntu" or ansible_lsb.id == "Debian")
  
- include_tasks: verify-package-rpm.yml
  when: ansible_distribution is defined and (ansible_distribution == 'CentOS' or ansible_distribution == 'openSUSE Leap')

- name: get path to downloaded headers
  shell: |
    kern_version=$(uname -r)
    header_path=lib/modules/$kern_version/build/include/generated/uapi/linux/version.h
    echo $header_path
  register: header_path

- name: stat "{{ output_path }}/{{ header_path.stdout }}"
  stat:
    path: "{{ output_path }}/{{ header_path.stdout }}"
  register: stat_result

- name: check kernel headers were successfully unpacked
  assert:
    that: stat_result.stat.exists
  ignore_errors: true
  

