---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars:
    prefix: "{{ lookup('env', 'NIKOS_PREFIX') }}"
  tasks:
  - name: create a directory if it does not exist
    file:
      path: /tmp/result
      state: directory
      mode: 0777

  - name: install bpftrace
    shell: "docker pull quay.io/iovisor/bpftrace:master-vanilla_llvm_clang_glibc2.23 && docker run -v $(pwd):/output quay.io/iovisor/bpftrace:master-vanilla_llvm_clang_glibc2.23 /bin/bash -c \"cp /usr/bin/bpftrace /output\" && cp ./bpftrace /usr/bin && chmod +x /usr/bin/bpftrace && bpftrace --version"
    register: bpftrace_install

  - debug:
      var: bpftrace_install.stdout_lines

  - name: run bpftrace
    shell: "bpftrace -e 'BEGIN { @start = nsecs; } tracepoint:kmem:rss_stat /args->member == 1 && comm == \"nikos\"/ { @[nsecs - @start] = args->size; } END { print(@, 1); clear(@) }' > /tmp/rss.log &"

  - name: display running processes
    shell: "ps -aux"
    register: procs

  - debug:
      var: procs.stdout_lines

  - name: show rss.log
    shell: "cat /tmp/rss.log"
    register: rss_log

  - debug:
      var: rss_log.stdout_lines

  - name: run nikos
    shell: "{{ prefix | default('', True) }} bash -c 'SSL_CERT_DIR=/opt/nikos/embedded/ssl/ PATH=$PATH:/opt/nikos/embedded/bin /opt/nikos/bin/nikos download --verbose --output /tmp/result 2>&1 tee /tmp/result/logs.txt'"
    register: nikos_result
    # ignore errors here so that we can pretty-print the nikos output before checking if it was successful
    ignore_errors: true 

  - debug:
      var: nikos_result.stdout_lines

  - name: print bpftrace ip
    shell: "pgrep bpftrace"
    register: bpftrace_pid

  - debug:
      var: bpftrace_pid.stdout_lines

  - name: terminate bpftrace
    shell: "kill -2 $(pgrep bpftrace | tr -d '\n\t\r')"

  - name: print max rss
    shell: "cat /tmp/rss.log"

  - name: nikos ran successfully
    assert:
      that: nikos_result.rc == 0

  - include_tasks: verify-package-deb.yml
    when: ansible_lsb.id is defined and (ansible_lsb.id == 'Ubuntu' or ansible_lsb.id == 'Debian')
    
  - include_tasks: verify-package-rpm.yml
    when: ansible_distribution is defined and (ansible_distribution == 'CentOS' or ansible_distribution == 'openSUSE Leap' or ansible_distribution == 'Fedora')

  - include_tasks: verify-headers.yml
    when: not (ansible_distribution is defined and (ansible_distribution == 'CentOS' or ansible_distribution == 'Fedora'))
    
  - include_tasks: verify-headers-fedora-centos.yml
    when: ansible_distribution is defined and (ansible_distribution == 'CentOS' or ansible_distribution == 'Fedora')
